<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HELLO SHOP | Premium Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #F85606; --bg: #f4f7f6; --gray-alert: #333333; --green-tick: #28a745; --red: #e74c3c; --blue: #3498db; }
        body { font-family: 'Poppins', sans-serif; margin:0; background: var(--bg); padding-bottom: 80px; overflow-x: hidden; }
        #loaderOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .spinner-bg { width: 50px; height: 50px; border: 5px solid #e0e0e0; border-top: 5px solid #888888; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #customToast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--gray-alert); color: white; padding: 12px 25px; border-radius: 8px; display: none; z-index: 5000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 14px; text-align: center; }
        #customConfirm { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--gray-alert); color: white; padding: 20px; border-radius: 12px; display: none; z-index: 6000; width: 80%; max-width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        header { background: var(--primary); color:white; padding:15px; text-align:center; font-weight:bold; font-size:20px; position: sticky; top:0; z-index:1000; }
        .search-area { background: white; padding: 10px; position: sticky; top: 55px; z-index: 999; border-bottom: 1px solid #eee; }
        #searchBar { width: 90%; padding: 10px 15px; display: block; margin: 0 auto; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        #products { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; cursor: pointer; }
        .card img { width: 100%; height: 140px; object-fit: cover; }
        .card-info { padding: 10px; }
        .price-tag { color: var(--primary); font-weight: 700; }
        .btn-group { display: flex; flex-direction: column; gap: 5px; padding: 0 10px 10px; }
        .btn-small { border: none; padding: 8px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; }
        .btn-order { background: var(--primary); color: white; }
        .btn-delete { background: var(--red); color: white; }
        .section { display: none; padding: 15px; }
        .active-section { display: block; }
        input, select, textarea { width: 92%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .slider { display: flex; overflow-x: auto; gap: 10px; scroll-snap-type: x mandatory; margin-bottom: 15px; }
        .slider img { width: 100%; flex-shrink: 0; scroll-snap-align: start; border-radius: 12px; height: 250px; object-fit: cover; }
        .old-price { text-decoration: line-through; color: var(--red); font-size: 14px; margin-right: 10px; }
        .new-price { color: var(--green-tick); font-size: 20px; font-weight: bold; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; float: right; }
        .Pending { background: #ffeaa7; color: #d35400; }
        .Packed { background: #e0f2f1; color: #00796b; }
        .Shipped { background: #d1d8ff; color: #2980b9; }
        .Delivered { background: #c8e6c9; color: #2e7d32; }
        .Cancelled { background: #f3f4f6; color: #6b7280; }
        .bottomNav { position:fixed; bottom:0; width:100%; height:70px; background: white; display:flex; justify-content:space-around; align-items:center; box-shadow:0 -3px 15px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { background: none; border: none; font-size: 10px; color: #666; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .nav-active { color: var(--primary); font-weight: bold; }
        #chatBtn { position: fixed; right: 20px; bottom: 85px; background: var(--primary); color: white; width: 55px; height: 55px; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 24px; z-index: 1001; }
        #chatWindow { position: fixed; right: 15px; bottom: 85px; width: 300px; height: 400px; background: white; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 2000; overflow: hidden; border: 1px solid #eee; }
        #chatMessages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; background: #f9f9f9; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 13px; }
        .msg-me { align-self: flex-end; background: var(--primary); color: white; }
        .msg-them { align-self: flex-start; background: #eee; color: #333; }
        .user-pic-container { width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin: 0 auto 10px; border: 3px solid var(--primary); }
        .payment-card { background: #fff8f5; border: 1px solid #ffccbc; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .admin-select-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .admin-select-header select { width: 60%; margin: 0; }
    </style>
</head>
<body>

<div id="loaderOverlay"><div class="spinner-bg"></div></div>
<div id="customToast">Notification</div>

<div id="customConfirm">
    <p id="confirmMsg" style="margin-bottom:20px;">Are you sure?</p>
    <div style="display:flex; gap:10px;">
        <button id="confirmOk" class="btn-main" style="padding:8px; font-size:12px;">OK</button>
        <button id="confirmCancel" class="btn-main" style="padding:8px; font-size:12px; background:#666;">Cancel</button>
    </div>
</div>

<header>HELLO SHOP</header>

<div id="chatBtn" onclick="toggleChat()">üí¨</div>
<div id="chatWindow">
    <div style="background:var(--primary); color:white; padding:12px; font-weight:bold; display:flex; justify-content:space-between;">
        <span>Support</span> <span onclick="toggleChat()" style="cursor:pointer">‚úñ</span>
    </div>
    <div id="chatMessages"></div>
    <div style="display:flex; padding:10px; border-top:1px solid #eee;">
        <input type="text" id="chatInput" placeholder="Message..." style="margin:0; flex:1;">
        <button onclick="sendMsg()" style="border:none; color:var(--primary); background:none; font-weight:bold; padding-left:10px;">Send</button>
    </div>
</div>

<div id="authPage" class="section active-section">
    <div style="text-align: center; padding-top: 50px;">
        <h2 style="color:var(--primary)">Login / Signup</h2>
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPass" placeholder="Password">
        <button class="btn-main" onclick="handleLogin()">Login</button>
        <button class="btn-main" style="background:#444; margin-top:10px" onclick="handleSignup()">Create Account</button>
    </div>
</div>

<div id="mainApp" style="display:none;">
    <div id="homeSection" class="section active-section">
        <div class="search-area"><input type="text" id="searchBar" placeholder="Search..." onkeyup="searchProducts()"></div>
        <div id="products">Loading...</div>
    </div>

    <div id="adminPanelSection" class="section">
        <div style="background: white; padding: 15px; border-radius: 12px; border:1px solid #ddd;">
            <h3 style="margin-top:0; color:var(--primary)">Admin Panel</h3>
            <div id="visitorStats" style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:15px; font-size:13px; border:1px solid #eee;">
                <b>Total Visitors Today:</b> <span id="visitorCount">0</span>
                <div id="visitorDetails" style="max-height:80px; overflow-y:auto; margin-top:5px; color:#666; font-size:11px;"></div>
            </div>
            <input type="text" id="pName" placeholder="Product Name">
            <input type="number" id="pPrice" placeholder="Base Price">
            <input type="file" id="pImgFile" accept="image/*" onchange="previewImg(this, 'adminP')">
            <img id="adminP" style="width:70px; display:none; margin:10px auto;">
            <button class="btn-main" onclick="addNewProduct()">Add Product (Home)</button>
            <hr>
            <h4>Upload Details</h4>
            <select id="detailSelectProduct"></select>
            <input type="number" id="detailDiscPrice" placeholder="Discount Price">
            <textarea id="detailDesc" placeholder="Description" rows="4"></textarea>
            <input type="file" id="detailPics" accept="image/*" multiple>
            <button class="btn-main" style="background:#444" onclick="uploadDetails()">Save Full Details</button>
        </div>
    </div>

    <div id="productDetailPage" class="section">
        <button onclick="switchSection('homeSection')" style="border:none; background:none; color:var(--primary); font-weight:bold; margin-bottom:15px;">‚Üê Back</button>
        <div id="detailSlider" class="slider"></div>
        <h2 id="detailTitle"></h2>
        <div><span id="detailOldPrice" class="old-price"></span><span id="detailNewPrice" class="new-price"></span></div>
        <p id="detailDescription"></p>
        <button class="btn-main" onclick="buyNowFromDetail()">Buy Now</button>
        <button class="btn-main" style="background:var(--blue); margin-top:10px" onclick="showToast('Added to Cart!')">Add to Cart</button>
    </div>

    <div id="ordersSection" class="section">
        <div class="admin-select-header" id="adminOrderHeader" style="display:none;">
            <h3 style="margin:0;">üì¶ Orders</h3>
            <select id="adminOrderSelect" onchange="toggleOrderDelBtn()"><option value="">Select Order</option></select>
        </div>
        <button id="adminDelOrderBtn" class="btn-main" style="display:none; margin-bottom:15px; background:var(--red);" onclick="deleteSelectedOrder()">Delete Order</button>
        <h3 id="userOrderTitle" style="text-align: center;">üì¶ My Orders</h3>
        <div id="userOrdersList"></div>
    </div>

    <div id="cartSection" class="section">
        <h3>Checkout</h3>
        <div id="cartItems" style="background:#fff; padding:10px; border-radius:8px; margin-bottom:10px;"></div>
        <div class="payment-card">
            <p style="margin-top:0; font-weight:bold; color:var(--primary)">Payment Method:</p>
            <p style="margin:2px 0; font-size:14px;"><b>JazzCash:</b> 03299469804</p>
            <p style="margin:2px 0; font-size:14px;"><b>Account Name:</b> SAJAWAL NAZEER</p>
            <small style="color:#666">Please upload proof below to confirm order.</small>
        </div>
        <input type="text" id="orderName" placeholder="Full Name">
        <input type="number" id="orderPhone" placeholder="WhatsApp Number">
        <textarea id="orderAddress" placeholder="Full Address" rows="2"></textarea>
        <div style="background:white; padding:10px; border-radius:8px; border:1px solid #ddd; margin-top:10px;">
            <label style="font-size:12px; font-weight:bold;">Transaction ID</label>
            <input type="text" id="orderTrxId" placeholder="Enter Trx ID" style="margin:5px 0;">
            <label style="font-size:12px; font-weight:bold;">Payment Screenshot</label>
            <input type="file" id="orderTrxImg" accept="image/*" style="font-size:11px;">
        </div>
        <button class="btn-main" style="background:var(--green-tick); margin-top:10px;" onclick="placeOrder()">Confirm Order (Rs <span id="cartTotal">0</span>)</button>
    </div>

    <div id="profileSection" class="section">
        <div style="text-align:center">
            <div class="user-pic-container"><img id="userProfilePic" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" style="width:100%; height:100%; object-fit:cover;"></div>
            <input type="file" id="userPicInput" style="display:none" onchange="uploadProfilePic(this)">
            <button class="btn-main" style="width:60%; font-size:12px; padding:8px; margin-bottom:10px" onclick="document.getElementById('userPicInput').click()">Upload Photo</button>
            <div id="userAddressBook" style="margin-top:20px; text-align:left; background:white; padding:15px; border-radius:10px; border:1px solid #ddd;">
                <label style="font-weight:bold; font-size:14px;">My Address Book</label>
                <textarea id="profileAddressInput" placeholder="Enter your delivery address..." rows="3"></textarea>
                <button class="btn-main" style="font-size:12px; padding:8px;" onclick="saveUserAddress()">Save Address</button>
            </div>
            <div id="adminPaymentProofs" style="display:none; margin-top:20px; text-align:left; background:white; padding:15px; border-radius:10px; border:1px solid #ddd;">
                <div class="admin-select-header">
                    <h4 style="margin:0; color:var(--primary)">Payment Proofs</h4>
                    <select id="adminProofSelect" onchange="toggleProofDelBtn()"><option value="">Select Proof</option></select>
                </div>
                <button id="adminDelProofBtn" class="btn-main" style="display:none; margin-bottom:15px; background:var(--red); padding:8px; font-size:12px;" onclick="deleteSelectedProof()">Delete Proof</button>
                <div id="proofsList" style="font-size:12px;">No proofs yet.</div>
            </div>
            <h3 id="displayEmail" style="margin-top:20px">User</h3>
            <button class="btn-main" style="background:#888" onclick="userLogout()">Logout</button>
        </div>
    </div>
</div>

<div id="bottomNav" class="bottomNav" style="display:none;">
    <button class="nav-item nav-active" onclick="switchSection('homeSection', this)"><span>üè†</span>Home</button>
    <button id="cartNavBtn" class="nav-item" onclick="switchSection('cartSection', this)"><span>üõí</span>Cart</button>
    <button class="nav-item" onclick="switchSection('ordersSection', this)"><span>üì¶</span>Orders</button>
    <button id="adminNavBtn" class="nav-item" style="display:none" onclick="switchSection('adminPanelSection', this)"><span>‚öôÔ∏è</span>Admin</button>
    <button class="nav-item" onclick="switchSection('profileSection', this)"><span>üë§</span>Profile</button>
</div>

<script>
const SUPABASE_URL = "https://urrqpsmhlzldtxzstnuu.supabase.co";
const SUPABASE_KEY = "sb_publishable_OmqQDQdf7ye8KXbviwFYng_zPdbZpWb";
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const ADMIN_EMAIL = "ligerplaz@gmail.com";
let currentUser = null, isAdmin = false, allProducts = [], adminBase64 = "", currentDetailProduct = null, userSavedAddress = "";
let confirmCallback = null;

function openConfirm(msg, callback) {
    document.getElementById('confirmMsg').innerText = msg;
    document.getElementById('customConfirm').style.display = 'block';
    confirmCallback = callback;
}
document.getElementById('confirmOk').onclick = () => {
    document.getElementById('customConfirm').style.display = 'none';
    if(confirmCallback) confirmCallback();
};
document.getElementById('confirmCancel').onclick = () => { document.getElementById('customConfirm').style.display = 'none'; };

// --- REPLACED VISITOR TRACKING LOGIC ---
async function logVisitor() {
    try {
        let loc = "Unknown Location";
        try {
            const res = await fetch('https://ipapi.co/json/');
            const data = await res.json();
            if(data.city) loc = `${data.city}, ${data.country_name}`;
        } catch(apiErr) { console.log("Location API Error, logging as unknown."); }

        await _supabase.from('visitors').insert([{ 
            email: currentUser?.email || "Guest", 
            location: loc 
        }]);
    } catch(e) { console.log("Visitor log failed completely."); }
}

async function fetchVisitors() {
    if(!isAdmin) return;
    const startOfToday = new Date();
    startOfToday.setHours(0,0,0,0);
    const { data, error } = await _supabase.from('visitors')
        .select('*')
        .gte('created_at', startOfToday.toISOString())
        .order('created_at', { ascending: false });
    
    if(data) {
        document.getElementById('visitorCount').innerText = data.length;
        document.getElementById('visitorDetails').innerHTML = data.map(v => {
            const time = new Date(v.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            return `‚Ä¢ [${time}] ${v.location} (${v.email})`;
        }).join('<br>');
    }
}
// ---------------------------------------

async function handleLogin() {
    const e = loginEmail.value.trim(), p = loginPass.value.trim();
    if(!e || !p) return showToast("Enter credentials");
    loaderOverlay.style.display = 'flex';
    const { data, error } = await _supabase.auth.signInWithPassword({ email: e, password: p });
    loaderOverlay.style.display = 'none';
    if(error) return showToast(error.message);
    currentUser = data.user; localStorage.setItem('helloShopUser', JSON.stringify(data.user)); setupApp(e);
    logVisitor();
}

async function handleSignup() {
    const { error } = await _supabase.auth.signUp({ email: loginEmail.value, password: loginPass.value });
    if(error) showToast(error.message); else showToast("Check Email!");
}

window.onload = () => {
    logVisitor();
    const saved = localStorage.getItem('helloShopUser');
    if(saved) { currentUser = JSON.parse(saved); setupApp(currentUser.email); }
};

function setupApp(email) {
    isAdmin = (email === ADMIN_EMAIL);
    document.getElementById('authPage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('bottomNav').style.display = 'flex';
    document.getElementById('chatBtn').style.display = 'flex';
    document.getElementById('displayEmail').innerText = email;
    if(isAdmin) {
        document.getElementById('adminNavBtn').style.display = 'flex';
        document.getElementById('cartNavBtn').style.display = 'none'; 
        document.getElementById('adminPaymentProofs').style.display = 'block';
        document.getElementById('userAddressBook').style.display = 'none';
        document.getElementById('adminOrderHeader').style.display = 'flex';
        document.getElementById('userOrderTitle').style.display = 'none';
        fetchProofs(); fetchVisitors();
    }
    loadProducts(); fetchOrders(); listenChat(); loadProfileData();
}

async function loadProfileData() {
    const { data } = await _supabase.from('profiles').select('*').eq('email', currentUser.email).maybeSingle();
    if(data) {
        if(data.profile_pic) document.getElementById('userProfilePic').src = data.profile_pic;
        if(data.address) {
            userSavedAddress = data.address;
            document.getElementById('profileAddressInput').value = data.address;
            document.getElementById('orderAddress').value = data.address;
        }
    }
}

async function saveUserAddress() {
    const addr = document.getElementById('profileAddressInput').value;
    loaderOverlay.style.display = 'flex';
    await _supabase.from('profiles').upsert([{ email: currentUser.email, address: addr }], { onConflict: 'email' });
    userSavedAddress = addr;
    document.getElementById('orderAddress').value = addr;
    loaderOverlay.style.display = 'none';
    showToast("Address Saved!");
}

async function uploadProfilePic(input) {
    const reader = new FileReader();
    reader.onload = async (e) => {
        loaderOverlay.style.display = 'flex';
        await _supabase.from('profiles').upsert([{ email: currentUser.email, profile_pic: e.target.result }], { onConflict: 'email' });
        document.getElementById('userProfilePic').src = e.target.result;
        loaderOverlay.style.display = 'none';
        showToast("Photo Updated!");
    };
    reader.readAsDataURL(input.files[0]);
}

async function loadProducts() {
    loaderOverlay.style.display = 'flex';
    const { data } = await _supabase.from('products').select('*').order('id', {ascending: false});
    allProducts = data || [];
    renderHomeProducts(allProducts);
    detailSelectProduct.innerHTML = allProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    loaderOverlay.style.display = 'none';
}

function renderHomeProducts(list) {
    products.innerHTML = list.map(p => `
        <div class="card" onclick="${!isAdmin ? `openDetail(${p.id})` : ''}">
            <img src="${p.img}">
            <div class="card-info"><h4>${p.name}</h4><span class="price-tag">Rs ${p.price}</span></div>
            <div class="btn-group">
                ${isAdmin ? `<button class="btn-small btn-delete" onclick="event.stopPropagation(); deleteProduct(${p.id})">DELETE</button>` 
                : `<button class="btn-small btn-order" onclick="event.stopPropagation(); openDetail(${p.id})">View Details</button>`}
            </div>
        </div>`).join('');
}

async function openDetail(id) {
    const p = allProducts.find(x => x.id === id);
    currentDetailProduct = p;
    loaderOverlay.style.display = 'flex';
    const { data } = await _supabase.from('product_details').select('*').eq('product_id', id).maybeSingle();
    loaderOverlay.style.display = 'none';
    document.getElementById('detailTitle').innerText = p.name;
    document.getElementById('detailOldPrice').innerText = "Rs " + p.price;
    if(data) {
        document.getElementById('detailDescription').innerText = data.description;
        document.getElementById('detailNewPrice').innerText = "Rs " + data.discount_price;
        detailSlider.innerHTML = (data.images || [p.img]).map(img => `<img src="${img}">`).join('');
    } else {
        document.getElementById('detailDescription').innerText = "No details.";
        document.getElementById('detailNewPrice').innerText = "Rs " + p.price;
        detailSlider.innerHTML = `<img src="${p.img}">`;
    }
    switchSection('productDetailPage');
}

async function fetchOrders() {
    const { data } = await _supabase.from('orders').select('*').order('id', {ascending: false});
    const list = isAdmin ? (data || []) : (data ? data.filter(o => o.user_email === currentUser.email) : []);
    if(isAdmin) {
        adminOrderSelect.innerHTML = '<option value="">Select Order</option>' + list.map(o => `<option value="${o.order_id}">${o.order_id} - ${o.customer_name}</option>`).join('');
    }
    userOrdersList.innerHTML = list.map(o => `
        <div style="background:white; padding:15px; border-radius:10px; margin-bottom:10px; border-left:5px solid var(--primary)">
            <span class="status-badge ${o.status}">${o.status}</span>
            <b>ID: ${o.order_id}</b><br>
            <small>Total: Rs ${o.total_price}</small>
            ${isAdmin ? `<div style="font-size:11px; margin-top:5px; padding:5px; background:#f9f9f9">
                üë§ <b>Customer:</b> ${o.customer_name}<br>
                üìû <b>WhatsApp:</b> ${o.customer_phone}<br>
                üìç <b>Address:</b> ${o.address}
            </div>
            <select style="margin-top:10px" onchange="updateStatus('${o.order_id}', this.value)">
                <option value="Pending" ${o.status==='Pending'?'selected':''}>Pending</option>
                <option value="Packed" ${o.status==='Packed'?'selected':''}>Packed</option>
                <option value="Shipped" ${o.status==='Shipped'?'selected':''}>Shipped</option>
                <option value="Delivered" ${o.status==='Delivered'?'selected':''}>Delivered</option>
                <option value="Cancelled" ${o.status==='Cancelled'?'selected':''}>Cancelled</option>
            </select>` : `
            <div style="margin-top:10px; display:flex; gap:5px;">
                ${o.status === 'Pending' ? `<button class="btn-small" style="background:var(--blue); color:white" onclick="updateStatus('${o.order_id}', 'Cancelled')">Cancel Order</button>` : ''}
                ${(o.status === 'Delivered' || o.status === 'Cancelled') ? `<button class="btn-small btn-delete" onclick="deleteOrder('${o.order_id}')">Delete Record</button>` : ''}
            </div>
            `}
        </div>`).join('');
}

async function fetchProofs() {
    const { data } = await _supabase.from('orders').select('*').not('trx_id', 'is', null).order('id', {ascending: false});
    if(!data) return;
    adminProofSelect.innerHTML = '<option value="">Select Proof</option>' + data.map(p => `<option value="${p.order_id}">${p.order_id} (Trx: ${p.trx_id})</option>`).join('');
    proofsList.innerHTML = data.map(p => `
        <div style="border-bottom:1px solid #eee; padding:10px 0;">
            <b>Order: ${p.order_id}</b><br>
            Trx ID: ${p.trx_id}<br>
            <img src="${p.trx_img}" style="width:100px; margin:5px 0; border:1px solid #ddd; cursor:pointer" onclick="window.open(this.src)"><br>
            <button class="btn-small btn-order" onclick="window.open('https://wa.me/${p.customer_phone}')">Confirm on WhatsApp</button>
        </div>
    `).join('');
}

function toggleOrderDelBtn() { adminDelOrderBtn.style.display = adminOrderSelect.value ? 'block' : 'none'; }
function toggleProofDelBtn() { adminDelProofBtn.style.display = adminProofSelect.value ? 'block' : 'none'; }

function deleteSelectedOrder() {
    const id = adminOrderSelect.value;
    openConfirm(`Delete Order ${id} permanently?`, async () => {
        loaderOverlay.style.display = 'flex';
        await _supabase.from('orders').delete().eq('order_id', id);
        loaderOverlay.style.display = 'none'; showToast("Order Deleted!"); fetchOrders(); adminDelOrderBtn.style.display = 'none';
    });
}

function deleteSelectedProof() {
    const id = adminProofSelect.value;
    openConfirm(`Remove Payment Proof for Order ${id}?`, async () => {
        loaderOverlay.style.display = 'flex';
        await _supabase.from('orders').update({ trx_id: null, trx_img: null }).eq('order_id', id);
        loaderOverlay.style.display = 'none'; showToast("Proof Removed!"); fetchProofs(); adminDelProofBtn.style.display = 'none';
    });
}

async function uploadDetails() {
    let imgs = []; loaderOverlay.style.display = 'flex';
    for(let f of detailPics.files) { imgs.push(await toBase64(f)); }
    await _supabase.from('product_details').upsert([{ product_id: detailSelectProduct.value, description: detailDesc.value, discount_price: detailDiscPrice.value, images: imgs }], { onConflict: 'product_id' });
    loaderOverlay.style.display = 'none'; showToast("Saved!"); switchSection('homeSection');
}

function toBase64(file) { return new Promise((resolve) => { const r = new FileReader(); r.readAsDataURL(file); r.onload = () => resolve(r.result); }); }
function previewImg(input, id) { const r = new FileReader(); r.onload = e => { adminBase64 = e.target.result; document.getElementById(id).src = e.target.result; document.getElementById(id).style.display = 'block'; }; r.readAsDataURL(input.files[0]); }
async function addNewProduct() { await _supabase.from('products').insert([{ name: pName.value, price: pPrice.value, img: adminBase64 }]); loadProducts(); }
async function deleteProduct(id) { openConfirm("Delete product?", async () => { await _supabase.from('products').delete().eq('id', id); loadProducts(); }); }
async function deleteOrder(id) { openConfirm("Delete record permanently?", async () => { await _supabase.from('orders').delete().eq('order_id', id); fetchOrders(); }); }

async function updateStatus(id, s) { 
    loaderOverlay.style.display = 'flex';
    await _supabase.from('orders').update({ status: s }).eq('order_id', id); 
    loaderOverlay.style.display = 'none';
    showToast("Status Updated & Notification Sent!");
    fetchOrders(); 
}

function switchSection(id, btn) { 
    document.querySelectorAll('.section').forEach(s => s.style.display = 'none'); 
    document.getElementById(id).style.display = 'block'; 
    if(btn) { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('nav-active')); btn.classList.add('nav-active'); }
}

function buyNowFromDetail() { 
    cartItems.innerHTML = `<b>${currentDetailProduct.name}</b>`; 
    cartTotal.innerText = document.getElementById('detailNewPrice').innerText.replace('Rs ', ''); 
    document.getElementById('orderAddress').value = userSavedAddress;
    switchSection('cartSection'); 
}

async function placeOrder() {
    const trxId = document.getElementById('orderTrxId').value;
    const trxImgFile = document.getElementById('orderTrxImg').files[0];
    if(!orderName.value || !orderPhone.value || !orderAddress.value || !trxId || !trxImgFile) { return showToast("Fill all details & Upload Proof!"); }
    loaderOverlay.style.display = 'flex';
    try {
        const trxBase64 = await toBase64(trxImgFile);
        const { error } = await _supabase.from('orders').insert([{ 
            order_id: 'ORD'+Math.floor(1000 + Math.random()*9000), user_email: currentUser.email, customer_name: orderName.value, customer_phone: orderPhone.value, total_price: cartTotal.innerText, status: 'Pending', address: orderAddress.value, trx_id: trxId, trx_img: trxBase64
        }]);
        if(error) throw error;
        showToast("Order Placed Successfully!"); switchSection('ordersSection'); fetchOrders();
    } catch (e) { showToast("Error: " + e.message); } finally { loaderOverlay.style.display = 'none'; }
}

function showToast(m) { customToast.innerText = m; customToast.style.display = 'block'; setTimeout(()=>customToast.style.display='none',3000); }
function userLogout() { localStorage.removeItem('helloShopUser'); location.reload(); }
function toggleChat() { chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex'; }
async function sendMsg() { await _supabase.from('messages').insert([{ sender: currentUser.email, text: chatInput.value, receiver: isAdmin ? "CUSTOMER" : ADMIN_EMAIL }]); chatInput.value = ""; }
function listenChat() { _supabase.channel('any').on('postgres_changes', { event: 'INSERT', table: 'messages' }, () => renderMessages()).subscribe(); renderMessages(); }
async function renderMessages() {
    const { data } = await _supabase.from('messages').select('*').order('created_at', {ascending: true});
    if(!data) return;
    chatMessages.innerHTML = data.filter(m => m.sender === currentUser.email || m.receiver === currentUser.email || isAdmin)
    .map(m => `<div class="msg ${m.sender === currentUser.email ? 'msg-me' : 'msg-them'}">${m.text}</div>`).join('');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}
function searchProducts() { renderHomeProducts(allProducts.filter(p => p.name.toLowerCase().includes(searchBar.value.toLowerCase()))); }
</script>
</body>
</html>
