<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HELLO SHOP | Premium Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #FF4F00; --bg: #f4f7f6; --gray-alert: #333333; --green-tick: #28a745; --red: #e74c3c; --blue: #3498db; --white: #ffffff; }
        body { font-family: 'Poppins', sans-serif; margin:0; background: var(--bg); padding-bottom: 80px; overflow-x: hidden; }
        #loaderOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .spinner-bg { width: 50px; height: 50px; border: 5px solid #e0e0e0; border-top: 5px solid #888888; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #customToast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--gray-alert); color: white; padding: 12px 25px; border-radius: 8px; display: none; z-index: 5000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 14px; text-align: center; }
        #customConfirm { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--gray-alert); color: white; padding: 20px; border-radius: 12px; display: none; z-index: 6000; width: 80%; max-width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        header { background: var(--primary); color:white; padding:15px; text-align:center; font-weight:bold; font-size:20px; position: sticky; top:0; z-index:1000; }
        .search-area { background: white; padding: 10px; position: sticky; top: 55px; z-index: 999; border-bottom: 1px solid #eee; }
        #searchBar { width: 90%; padding: 10px 15px; display: block; margin: 0 auto; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        #products { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; cursor: pointer; }
        .card img { width: 100%; height: 140px; object-fit: cover; }
        .card-info { padding: 10px; }
        .price-tag { color: var(--primary); font-weight: 700; }
        .btn-group { display: flex; flex-direction: column; gap: 5px; padding: 0 10px 10px; }
        .btn-small { border: none; padding: 8px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; }
        .btn-order { background: var(--primary); color: white; }
        .btn-delete { background: var(--red); color: white; }
        .section { display: none; padding: 15px; }
        .active-section { display: block; }
        input, select, textarea { width: 92%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; box-sizing: border-box; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .slider { display: flex; overflow-x: auto; gap: 10px; scroll-snap-type: x mandatory; margin-bottom: 15px; }
        .slider img { width: 100%; flex-shrink: 0; scroll-snap-align: start; border-radius: 12px; height: 250px; object-fit: cover; }
        .old-price { text-decoration: line-through; color: var(--red); font-size: 14px; margin-right: 10px; }
        .new-price { color: var(--green-tick); font-size: 20px; font-weight: bold; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; float: right; }
        .stock-badge { display: inline-block; padding: 2px 8px; background: #e8f5e9; color: #2e7d32; border-radius: 5px; font-size: 12px; margin-bottom: 10px; font-weight: 600; }
        .out-of-stock { background: #ffebee; color: #c62828; }
        .bottomNav { position:fixed; bottom:0; width:100%; height:70px; background: white; display:flex; justify-content:space-around; align-items:center; box-shadow:0 -3px 15px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { background: none; border: none; font-size: 10px; color: #666; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .nav-active { color: var(--primary); font-weight: bold; }
        #chatBtn { position: fixed; right: 20px; bottom: 85px; background: var(--primary); color: white; width: 55px; height: 55px; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 24px; z-index: 1001; }
        #chatWindow { position: fixed; right: 15px; bottom: 85px; width: 300px; height: 400px; background: white; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 2000; overflow: hidden; border: 1px solid #eee; }
        #chatMessages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; background: #f9f9f9; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 13px; }
        .msg-me { align-self: flex-end; background: var(--primary); color: white; }
        .msg-them { align-self: flex-start; background: #eee; color: #333; }
        .msg-header { display: flex; align-items: center; margin-bottom: 5px; font-size: 12px; font-weight: bold; }
        .msg-header img { width: 25px; height: 25px; border-radius: 50%; margin-right: 5px; }
        .msg-me .msg-header { flex-direction: row-reverse; text-align: right; }
        .msg-them .msg-header { text-align: left; }
        .user-pic-container { width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin: 0 auto 10px; border: 3px solid var(--primary); }
        .payment-card { background: #fff8f5; border: 1px solid #ffccbc; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .admin-select-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

        /* Login Security Features */
        .pass-container { position: relative; width: 92%; margin: 10px auto; }
        .pass-container input { width: 100%; margin: 0; padding-right: 40px; }
        .toggle-pass { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999; font-size: 18px; user-select: none; background: transparent; }
        .forgot-link { display: block; margin-top: 15px; color: var(--primary); font-size: 12px; text-decoration: none; cursor: pointer; font-weight: 500; }

        /* Edit Product Section Styles */
        #editProductSection { background: var(--white); padding: 20px; border-radius: 12px; border: 1px solid var(--primary); }
        #editProductSection h3 { color: var(--primary); }
        #editProductSection .btn-main { background: var(--primary); color: var(--white); }
        .preview-img { width: 70px; margin: 5px; border-radius: 8px; }
        #currentVideoPreview { width: 100%; height: 150px; margin-bottom: 10px; }

        /* Order Section for Admin */
        #ordersSection select { background: var(--white); border: 1px solid var(--primary); color: var(--primary); }
        #ordersSection .btn-main { background: var(--primary); color: var(--white); }

        /* Cart Item */
        .cart-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; }
        .cart-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
        .cart-item input[type="checkbox"] { margin-right: 10px; }

        /* Google Sign-in Button */
        .google-btn { background: #4285F4; color: white; border: none; padding: 14px; width: 92%; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; position: relative; }
        .google-btn.disabled { background: #ddd; cursor: not-allowed; }
        .lock-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #888; }

        /* Popup for Google */
        #googlePopup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(51, 51, 51, 0.8); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .popup-content { background: #f4f7f6; padding: 20px; border-radius: 12px; text-align: center; width: 80%; max-width: 300px; }
        .popup-content h2 { color: var(--primary); margin-bottom: 10px; }
        .popup-content button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

<div id="loaderOverlay"><div class="spinner-bg"></div></div>
<div id="customToast">Notification</div>

<div id="customConfirm">
    <p id="confirmMsg" style="margin-bottom:20px;">Are you sure?</p>
    <div style="display:flex; gap:10px;">
        <button id="confirmOk" class="btn-main" style="padding:8px; font-size:12px;">OK</button>
        <button id="confirmCancel" class="btn-main" style="padding:8px; font-size:12px; background:var(--white); color:var(--primary);">Cancel</button>
    </div>
</div>

<header>HELLO SHOP</header>

<div id="chatBtn" onclick="toggleChat()">üí¨</div>
<div id="chatWindow">
    <div style="background:var(--primary); color:white; padding:12px; font-weight:bold; display:flex; justify-content:space-between;">
        <span>Support</span> <span onclick="toggleChat()" style="cursor:pointer">‚úñ</span>
    </div>
    <div id="chatMessages"></div>
    <div style="display:flex; padding:10px; border-top:1px solid #eee;">
        <input type="text" id="chatInput" placeholder="Message..." style="margin:0; flex:1;">
        <button onclick="sendMsg()" style="border:none; color:var(--primary); background:none; font-weight:bold; padding-left:10px;">Send</button>
    </div>
</div>

<div id="authPage" class="section active-section">
    <div style="text-align: center; padding-top: 50px;">
        <h2 style="color:var(--primary)">Login / Signup</h2>
        <input type="email" id="loginEmail" placeholder="Email">
        <div class="pass-container">
            <input type="password" id="loginPass" placeholder="Password">
            <span class="toggle-pass" onclick="togglePass('loginPass')">üëÅÔ∏è</span>
        </div>
        <button class="btn-main" onclick="handleLogin()" style="width: 92%;">Login</button>
        <button class="btn-main" style="background:#444; margin-top:10px; width: 92%;" onclick="handleSignup()">Create Account</button>
        <button class="google-btn disabled" onclick="showGooglePopup()" style="width: 92%;">Continue with Google <span class="lock-icon">üîí</span></button>
        <a class="forgot-link" onclick="handleForgetPassword()">Forgot Password?</a>
    </div>
</div>

<div id="googlePopup">
    <div class="popup-content">
        <h2>Not available yet</h2>
        <button onclick="closeGooglePopup()">Back</button>
    </div>
</div>

<div id="resetPage" class="section">
    <div style="text-align: center; padding-top: 50px;">
        <h2 style="color:var(--primary)">Set New Password</h2>
        <p style="font-size: 12px; color: #666;">Enter your new password below</p>
        <div class="pass-container">
            <input type="password" id="newPass" placeholder="New Password">
            <span class="toggle-pass" onclick="togglePass('newPass')">üëÅÔ∏è</span>
        </div>
        <button class="btn-main" onclick="updatePassword()" style="width: 92%;">Update Password</button>
    </div>
</div>

<div id="mainApp" style="display:none;">
    <div id="homeSection" class="section active-section">
        <div class="search-area"><input type="text" id="searchBar" placeholder="Search..." onkeyup="searchProducts()"></div>
        <div id="products">Loading...</div>
    </div>

    <div id="adminPanelSection" class="section">
        <div style="background: white; padding: 15px; border-radius: 12px; border:1px solid #ddd;">
            <h3 style="margin-top:0; color:var(--primary)">Admin Panel</h3>
            <input type="text" id="pName" placeholder="Product Name">
            <textarea id="pDesc" placeholder="Description" rows="4"></textarea>
            <input type="number" id="pBasePrice" placeholder="Base Price">
            <input type="number" id="pDiscPrice" placeholder="Discount Price">
            <input type="number" id="pStock" placeholder="Quantity (Stock)">
            <input type="file" id="pImages" accept="image/*" multiple>
            <input type="file" id="pVideo" accept="video/*">
            <button class="btn-main" onclick="addNewProduct()">Add Product</button>
        </div>
    </div>

    <div id="editProductSection" class="section">
        <button onclick="switchSection('homeSection')" style="border:none; background:none; color:var(--primary); font-weight:bold; margin-bottom:15px;">‚Üê Back</button>
        <h3 style="color:var(--primary)">Edit Product</h3>
        <input type="text" id="editPName" placeholder="Product Name">
        <textarea id="editPDesc" placeholder="Description" rows="4"></textarea>
        <input type="number" id="editPBasePrice" placeholder="Base Price">
        <input type="number" id="editPDiscPrice" placeholder="Discount Price">
        <input type="number" id="editPStock" placeholder="Quantity (Stock)">
        <div id="currentImagesPreview"></div>
        <input type="file" id="editPImages" accept="image/*" multiple>
        <div id="currentVideoPreview"></div>
        <input type="file" id="editPVideo" accept="video/*">
        <button class="btn-main" onclick="saveEditedProduct()">Save Changes</button>
    </div>

    <div id="productDetailPage" class="section">
        <button onclick="switchSection('homeSection')" style="border:none; background:none; color:var(--primary); font-weight:bold; margin-bottom:15px;">‚Üê Back</button>
        <div id="detailSlider" class="slider"></div>
        <div id="detailVideo"></div>
        <div id="stockInfo" class="stock-badge"></div>
        <h2 id="detailTitle"></h2>
        <div><span id="detailOldPrice" class="old-price"></span><span id="detailNewPrice" class="new-price"></span></div>
        <p id="detailDescription"></p>
        <div id="detailActionBtn"></div>
    </div>

    <div id="ordersSection" class="section">
        <div class="admin-select-header" id="adminOrderHeader" style="display:none;">
            <h3 style="margin:0;">üì¶ Orders</h3>
            <select id="adminOrderSelect" onchange="toggleOrderDelBtn()"><option value="">Select Order</option></select>
        </div>
        <button id="adminDelOrderBtn" class="btn-main" style="display:none; margin-bottom:15px; background:var(--red);" onclick="deleteSelectedOrder()">Delete Order</button>
        <h3 id="userOrderTitle" style="text-align: center;">üì¶ My Orders</h3>
        <div id="userOrdersList"></div>
    </div>

    <div id="cartSection" class="section">
        <h3>Checkout</h3>
        <div style="position: relative;">
            <div id="cartItems" style="background:#fff; padding:10px; border-radius:8px; margin-bottom:10px;"></div>
            <button id="deleteSelectedCart" class="btn-small btn-delete" style="position: absolute; top: 0; right: 0; display: none;" onclick="deleteSelectedCartItems()">Delete Selected</button>
        </div>
        <button id="checkoutBtn" class="btn-main" style="display:none; margin-bottom:10px;" onclick="showCheckoutForm()">Checkout Selected</button>
        
        <div id="checkoutForm" style="display:none;">
            <label style="font-size:12px; font-weight:bold;">Payment Method</label>
            <select id="payMethodSelect" onchange="togglePaymentUI()">
                <option value="jazzcash">JazzCash (Online)</option>
                <option value="cod" id="codOption" disabled>Cash on Delivery (Only Layyah)</option>
            </select>
            <div id="codNotice" style="color:red; font-size:10px; margin-top:-5px; display:none;">COD only available in Layyah city.</div>

            <div id="jazzcashDetails" class="payment-card">
                <p style="margin-top:0; font-weight:bold; color:var(--primary)">JazzCash Payment:</p>
                <p style="margin:2px 0; font-size:14px;"><b>Number:</b> 03299469804</p>
                <p style="margin:2px 0; font-size:14px;"><b>Name:</b> SAJAWAL NAZEER</p>
            </div>

            <input type="text" id="orderName" placeholder="Full Name">
            <input type="number" id="orderPhone" placeholder="WhatsApp Number">
            <textarea id="orderAddress" placeholder="Full Address (Mention City)" rows="2" onkeyup="checkLayyahCity()"></textarea>

            <div id="paymentProofUI" style="background:white; padding:10px; border-radius:8px; border:1px solid #ddd; margin-top:10px;">
                <label style="font-size:12px; font-weight:bold;">Transaction ID</label>
                <input type="text" id="orderTrxId" placeholder="Enter Trx ID" style="margin:5px 0;">
                <label style="font-size:12px; font-weight:bold;">Payment Screenshot</label>
                <input type="file" id="orderTrxImg" accept="image/*" style="font-size:11px;">
            </div>
            
            <button class="btn-main" style="background:var(--green-tick); margin-top:10px;" onclick="placeOrder()">Confirm Order (Rs <span id="cartTotal">0</span>)</button>
        </div>
    </div>

    <div id="buyNowSection" class="section" style="background: #f4f7f6;">
        <h3>Buy Now</h3>
        <div id="buyNowItem" style="background:#fff; padding:10px; border-radius:8px; margin-bottom:10px;"></div>
        <label style="font-size:12px; font-weight:bold;">Payment Method</label>
        <select id="buyNowPayMethodSelect" onchange="toggleBuyNowPaymentUI()">
            <option value="jazzcash">JazzCash (Online)</option>
            <option value="cod" id="buyNowCodOption" disabled>Cash on Delivery (Only Layyah)</option>
        </select>
        <div id="buyNowCodNotice" style="color:red; font-size:10px; margin-top:-5px; display:none;">COD only available in Layyah city.</div>

        <div id="buyNowJazzcashDetails" class="payment-card">
            <p style="margin-top:0; font-weight:bold; color:var(--primary)">JazzCash Payment:</p>
            <p style="margin:2px 0; font-size:14px;"><b>Number:</b> 03299469804</p>
            <p style="margin:2px 0; font-size:14px;"><b>Name:</b> SAJAWAL NAZEER</p>
        </div>

        <input type="text" id="buyNowOrderName" placeholder="Full Name">
        <input type="number" id="buyNowOrderPhone" placeholder="WhatsApp Number">
        <textarea id="buyNowOrderAddress" placeholder="Full Address (Mention City)" rows="2" onkeyup="checkBuyNowLayyahCity()"></textarea>

        <div id="buyNowPaymentProofUI" style="background:white; padding:10px; border-radius:8px; border:1px solid #ddd; margin-top:10px;">
            <label style="font-size:12px; font-weight:bold;">Transaction ID</label>
            <input type="text" id="buyNowOrderTrxId" placeholder="Enter Trx ID" style="margin:5px 0;">
            <label style="font-size:12px; font-weight:bold;">Payment Screenshot</label>
            <input type="file" id="buyNowOrderTrxImg" accept="image/*" style="font-size:11px;">
        </div>
        
        <button class="btn-main" style="background:var(--green-tick); margin-top:10px;" onclick="placeBuyNowOrder()">Confirm Order (Rs <span id="buyNowTotal">0</span>)</button>
    </div>

    <div id="profileSection" class="section">
        <div style="text-align:center">
            <h3 id="userNameDisplay" style="color: var(--primary); margin-bottom: 10px; display: none;"></h3>
            <div class="user-pic-container"><img id="userProfilePic" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" style="width:100%; height:100%; object-fit:cover;"></div>
            <input type="file" id="userPicInput" style="display:none" onchange="uploadProfilePic(this)">
            <button class="btn-main" style="width:60%; font-size:12px; padding:8px; margin-bottom:10px" onclick="document.getElementById('userPicInput').click()">Upload Photo</button>
            <div id="userNameBook" style="margin-top:20px; text-align:left; background:white; padding:15px; border-radius:10px; border:1px solid #ddd; display:none;">
                <label style="font-weight:bold; font-size:14px;">My Full Name</label>
                <input type="text" id="profileNameInput" placeholder="Enter your full name...">
                <button class="btn-main" style="font-size:12px; padding:8px;" onclick="saveUserName()">Save Name</button>
                <button id="editNameBtn" class="btn-main" style="display:none; font-size:12px; padding:8px; background:var(--blue);" onclick="editUserName()">Edit Name</button>
            </div>
            <div id="userAddressBook" style="margin-top:20px; text-align:left; background:white; padding:15px; border-radius:10px; border:1px solid #ddd; display:none;">
                <label style="font-weight:bold; font-size:14px;">My Address Book</label>
                <textarea id="profileAddressInput" placeholder="Enter your delivery address..." rows="3"></textarea>
                <button class="btn-main" style="font-size:12px; padding:8px;" onclick="saveUserAddress()">Save Address</button>
            </div>
            <div id="adminPaymentProofs" style="display:none; margin-top:20px; text-align:left; background:white; padding:15px; border-radius:10px; border:1px solid #ddd;">
                <div class="admin-select-header">
                    <h4 style="margin:0; color:var(--primary)">Payment Proofs</h4>
                    <select id="adminProofSelect" onchange="toggleProofDelBtn()"><option value="">Select Proof</option></select>
                </div>
                <button id="adminDelProofBtn" class="btn-main" style="display:none; margin-bottom:15px; background:var(--red); padding:8px; font-size:12px;" onclick="deleteSelectedProof()">Delete Proof</button>
                <div id="proofsList" style="font-size:12px;">No proofs yet.</div>
            </div>
            <h3 id="displayEmail" style="margin-top:20px">User</h3>
            <button class="btn-main" style="background:#888" onclick="userLogout()">Logout</button>
        </div>
    </div>
</div>

<div id="bottomNav" class="bottomNav" style="display:none;">
    <button class="nav-item nav-active" onclick="switchSection('homeSection', this)"><span>üè†</span>Home</button>
    <button id="cartNavBtn" class="nav-item" onclick="switchSection('cartSection', this)"><span>üõí</span>Cart</button>
    <button class="nav-item" onclick="switchSection('ordersSection', this)"><span>üì¶</span>Orders</button>
    <button id="adminNavBtn" class="nav-item" style="display:none" onclick="switchSection('adminPanelSection', this)"><span>‚öôÔ∏è</span>Admin</button>
    <button class="nav-item" onclick="switchSection('profileSection', this)"><span>üë§</span>Profile</button>
</div>

<script>
const SUPABASE_URL = "https://urrqpsmhlzldtxzstnuu.supabase.co";
const SUPABASE_KEY = "sb_publishable_OmqQDQdf7ye8KXbviwFYng_zPdbZpWb";
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const ADMIN_EMAIL = "ligerplaz@gmail.com";
let currentUser = null, isAdmin = false, allProducts = [], currentDetailProduct = null, userSavedAddress = "", userSavedName = "", editingProduct = null;
let confirmCallback = null, userProfiles = {};

function togglePass(id) {
    const p = document.getElementById(id);
    p.type = p.type === 'password' ? 'text' : 'password';
}

async function handleForgetPassword() {
    const email = loginEmail.value.trim();
    if(!email) return showToast("Enter your email first!");
    loaderOverlay.style.display = 'flex';
    const { error } = await _supabase.auth.resetPasswordForEmail(email);
    loaderOverlay.style.display = 'none';
    if(error) showToast(error.message);
    else showToast("Password reset link sent to email!");
}

async function updatePassword() {
    const pass = newPass.value.trim();
    if(pass.length < 6) return showToast("Min 6 characters required");
    loaderOverlay.style.display = 'flex';
    const { error } = await _supabase.auth.updateUser({ password: pass });
    loaderOverlay.style.display = 'none';
    if(error) showToast(error.message);
    else { showToast("Password Updated! Logged in."); location.reload(); }
}

function openConfirm(msg, callback) {
    document.getElementById('confirmMsg').innerText = msg;
    document.getElementById('customConfirm').style.display = 'block';
    confirmCallback = callback;
}
document.getElementById('confirmOk').onclick = () => {
    document.getElementById('customConfirm').style.display = 'none';
    if(confirmCallback) confirmCallback();
};
document.getElementById('confirmCancel').onclick = () => { document.getElementById('customConfirm').style.display = 'none'; };

function showGooglePopup() {
    document.getElementById('googlePopup').style.display = 'flex';
}

function closeGooglePopup() {
    document.getElementById('googlePopup').style.display = 'none';
}

function checkLayyahCity() {
    const addr = document.getElementById('orderAddress').value.toLowerCase();
    const codOpt = document.getElementById('codOption');
    const notice = document.getElementById('codNotice');
    if(addr.includes("layyah")) {
        codOpt.disabled = false;
        notice.style.display = 'none';
    } else {
        codOpt.disabled = true;
        notice.style.display = 'block';
        if(document.getElementById('payMethodSelect').value === 'cod') {
            document.getElementById('payMethodSelect').value = 'jazzcash';
            togglePaymentUI();
        }
    }
}

function checkBuyNowLayyahCity() {
    const addr = document.getElementById('buyNowOrderAddress').value.toLowerCase();
    const codOpt = document.getElementById('buyNowCodOption');
    const notice = document.getElementById('buyNowCodNotice');
    if(addr.includes("layyah")) {
        codOpt.disabled = false;
        notice.style.display = 'none';
    } else {
        codOpt.disabled = true;
        notice.style.display = 'block';
        if(document.getElementById('buyNowPayMethodSelect').value === 'cod') {
            document.getElementById('buyNowPayMethodSelect').value = 'jazzcash';
            toggleBuyNowPaymentUI();
        }
    }
}

function togglePaymentUI() {
    const method = document.getElementById('payMethodSelect').value;
    const proofUI = document.getElementById('paymentProofUI');
    const jcDetails = document.getElementById('jazzcashDetails');
    if(method === 'cod') {
        proofUI.style.display = 'none';
        jcDetails.style.display = 'none';
    } else {
        proofUI.style.display = 'block';
        jcDetails.style.display = 'block';
    }
}

function toggleBuyNowPaymentUI() {
    const method = document.getElementById('buyNowPayMethodSelect').value;
    const proofUI = document.getElementById('buyNowPaymentProofUI');
    const jcDetails = document.getElementById('buyNowJazzcashDetails');
    if(method === 'cod') {
        proofUI.style.display = 'none';
        jcDetails.style.display = 'none';
    } else {
        proofUI.style.display = 'block';
        jcDetails.style.display = 'block';
    }
}

async function logVisitor() {
    if(currentUser && currentUser.email === ADMIN_EMAIL) return;
    try {
        let loc = "Unknown Location";
        try { const res = await fetch('https://ipapi.co/json/'); const data = await res.json(); if(data.city) loc = `${data.city}, ${data.country_name}`; } catch(e){}
        await _supabase.from('visitors').insert([{ email: currentUser?.email || "Guest", location: loc }]);
        const old = new Date(Date.now() - 86400000).toISOString();
        await _supabase.from('visitors').delete().lt('created_at', old);
    } catch(e) {}
}

async function handleLogin() {
    const e = loginEmail.value.trim(), p = loginPass.value.trim();
    if(!e || !p) return showToast("Enter credentials");
    loaderOverlay.style.display = 'flex';
    const { data, error } = await _supabase.auth.signInWithPassword({ email: e, password: p });
    loaderOverlay.style.display = 'none';
    if(error) return showToast(error.message);
    currentUser = data.user; localStorage.setItem('helloShopUser', JSON.stringify(data.user)); setupApp(e);
    logVisitor();
}

async function handleSignup() {
    const { error } = await _supabase.auth.signUp({ email: loginEmail.value, password: loginPass.value });
    if(error) showToast(error.message); else showToast("Check Email!");
}

window.onload = () => {
    if(window.location.hash.includes('type=recovery')) {
        document.getElementById('authPage').style.display = 'none';
        document.getElementById('resetPage').style.display = 'block';
        return;
    }
    const saved = localStorage.getItem('helloShopUser');
    if(saved) { currentUser = JSON.parse(saved); setupApp(currentUser.email); logVisitor(); } else { logVisitor(); }
};

function setupApp(email) {
    isAdmin = (email === ADMIN_EMAIL);
    document.getElementById('authPage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('bottomNav').style.display = 'flex';
    document.getElementById('chatBtn').style.display = 'flex';
    if(isAdmin) {
        document.getElementById('displayEmail').innerHTML = '<span style="color: var(--primary);">ADMIN</span>';
        document.getElementById('adminNavBtn').style.display = 'flex';
        document.getElementById('cartNavBtn').style.display = 'none'; 
        document.getElementById('adminPaymentProofs').style.display = 'block';
        document.getElementById('adminOrderHeader').style.display = 'flex';
        document.getElementById('userOrderTitle').style.display = 'none';
        fetchProofs(); // Removed fetchVisitors
    } else {
        document.getElementById('displayEmail').innerText = email;
        document.getElementById('userNameBook').style.display = 'block';
        document.getElementById('userAddressBook').style.display = 'block';
    }
    loadProducts(); fetchOrders(); listenChat(); loadProfileData(); renderCart();
}

async function loadProfileData() {
    const { data } = await _supabase.from('profiles').select('*').eq('email', currentUser.email).maybeSingle();
    if(data) {
        if(data.profile_pic) document.getElementById('userProfilePic').src = data.profile_pic;
        if(data.full_name) {
            userSavedName = data.full_name;
            document.getElementById('userNameDisplay').innerText = data.full_name;
            document.getElementById('userNameDisplay').style.display = 'block';
            document.getElementById('profileNameInput').value = data.full_name;
            document.getElementById('profileNameInput').style.display = 'none';
            document.getElementById('saveNameBtn').style.display = 'none';
            document.getElementById('editNameBtn').style.display = 'block';
            document.getElementById('orderName').value = data.full_name;
            document.getElementById('buyNowOrderName').value = data.full_name;
        }
        if(data.address) {
            userSavedAddress = data.address;
            document.getElementById('profileAddressInput').value = data.address;
            document.getElementById('orderAddress').value = data.address;
            document.getElementById('buyNowOrderAddress').value = data.address;
            checkLayyahCity();
            checkBuyNowLayyahCity();
        }
    }
}

async function saveUserName() {
    const name = document.getElementById('profileNameInput').value;
    if (!name) return showToast("Enter your name!");
    loaderOverlay.style.display = 'flex';
    await _supabase.from('profiles').upsert([{ email: currentUser.email, full_name: name }], { onConflict: 'email' });
    userSavedName = name;
    document.getElementById('userNameDisplay').innerText = name;
    document.getElementById('userNameDisplay').style.display = 'block';
    document.getElementById('profileNameInput').style.display = 'none';
    document.getElementById('saveNameBtn').style.display = 'none';
    document.getElementById('editNameBtn').style.display = 'block';
    document.getElementById('orderName').value = name;
    document.getElementById('buyNowOrderName').value = name;
    loaderOverlay.style.display = 'none';
    showToast("Name Saved!");
}

function editUserName() {
    document.getElementById('userNameDisplay').style.display = 'none';
    document.getElementById('profileNameInput').style.display = 'block';
    document.getElementById('saveNameBtn').style.display = 'block';
    document.getElementById('editNameBtn').style.display = 'none';
}

async function saveUserAddress() {
    const addr = document.getElementById('profileAddressInput').value;
    loaderOverlay.style.display = 'flex';
    await _supabase.from('profiles').upsert([{ email: currentUser.email, address: addr }], { onConflict: 'email' });
    userSavedAddress = addr;
    document.getElementById('orderAddress').value = addr;
    document.getElementById('buyNowOrderAddress').value = addr;
    loaderOverlay.style.display = 'none';
    showToast("Address Saved!");
    checkLayyahCity();
    checkBuyNowLayyahCity();
}

async function uploadProfilePic(input) {
    const reader = new FileReader();
    reader.onload = async (e) => {
        loaderOverlay.style.display = 'flex';
        await _supabase.from('profiles').upsert([{ email: currentUser.email, profile_pic: e.target.result }], { onConflict: 'email' });
        document.getElementById('userProfilePic').src = e.target.result;
        loaderOverlay.style.display = 'none';
        showToast("Photo Updated!");
    };
    reader.readAsDataURL(input.files[0]);
}

async function loadProducts() {
    loaderOverlay.style.display = 'flex';
    const { data } = await _supabase.from('products').select('*').order('id', {ascending: false});
    allProducts = data || [];
    renderHomeProducts(allProducts);
    loaderOverlay.style.display = 'none';
}

function renderHomeProducts(list) {
    products.innerHTML = list.map(p => `
        <div class="card" onclick="openDetail(${p.id})">
            <img src="${p.img}">
            <div class="card-info">
                <h4>${p.name}</h4>
                <span class="price-tag">Rs ${p.price}</span>
                <div style="font-size:10px; color:#888;">Stock: ${p.stock || 0}</div>
            </div>
            <div class="btn-group">
                ${isAdmin ? `<button class="btn-small btn-delete" onclick="event.stopPropagation(); deleteProduct(${p.id})">DELETE</button>` : ''}
            </div>
        </div>`).join('');
}

async function openDetail(id) {
    const p = allProducts.find(x => x.id === id);
    currentDetailProduct = {...p};
    loaderOverlay.style.display = 'flex';
    const { data } = await _supabase.from('product_details').select('*').eq('product_id', id).maybeSingle();
    loaderOverlay.style.display = 'none';
    if(data) {
        currentDetailProduct.desc = data.description;
        currentDetailProduct.disc_price = data.discount_price;
        currentDetailProduct.images = data.images;
        currentDetailProduct.video = data.video;
    }
    document.getElementById('detailTitle').innerText = p.name;
    document.getElementById('detailOldPrice').innerText = "Rs " + p.price;
    document.getElementById('detailNewPrice').innerText = "Rs " + (currentDetailProduct.disc_price || p.price);
    document.getElementById('detailDescription').innerText = currentDetailProduct.desc || "No details.";
    detailSlider.innerHTML = (currentDetailProduct.images || [p.img]).map(img => `<img src="${img}">`).join('');
    document.getElementById('detailVideo').innerHTML = currentDetailProduct.video ? `<video controls src="${currentDetailProduct.video}" style="width:100%; height:250px; border-radius:12px;"></video>` : '';
    const stock = p.stock || 0;
    const stockLabel = document.getElementById('stockInfo');
    if(stock > 0) { stockLabel.innerText = `${stock} items in stock`; stockLabel.className = 'stock-badge'; } 
    else { stockLabel.innerText = `Out of Stock`; stockLabel.className = 'stock-badge out-of-stock'; }
    const actionBtn = document.getElementById('detailActionBtn');
    if(isAdmin) {
        actionBtn.innerHTML = `
            <button class="btn-main" onclick="editProduct(${id})">Edit Product</button>
            <button class="btn-main" style="background:var(--red); margin-top:10px" onclick="deleteProduct(${id})">Delete Product</button>
        `;
    } else {
        actionBtn.innerHTML = stock > 0 ? `
            <button class="btn-main" onclick="buyNowFromDetail()">Buy Now</button>
            <button class="btn-main" style="background:var(--blue); margin-top:10px" onclick="addToCart()">Add to Cart</button>
        ` : '';
    }
    switchSection('productDetailPage');
}

async function buyNowFromDetail() {
    if (currentDetailProduct.stock <= 0) return showToast("Out of stock!");
    const item = {
        id: currentDetailProduct.id,
        name: currentDetailProduct.name,
        price: currentDetailProduct.disc_price || currentDetailProduct.price,
        img: currentDetailProduct.img
    };
    document.getElementById('buyNowItem').innerHTML = `
        <div class="cart-item">
            <img src="${item.img}">
            <div>
                <b>${item.name}</b><br>
                Rs ${item.price}
            </div>
        </div>
    `;
    document.getElementById('buyNowTotal').innerText = item.price;
    document.getElementById('buyNowOrderName').value = userSavedName;
    document.getElementById('buyNowOrderAddress').value = userSavedAddress;
    checkBuyNowLayyahCity();
    toggleBuyNowPaymentUI();
    switchSection('buyNowSection');
}

async function placeBuyNowOrder() {
    const method = document.getElementById('buyNowPayMethodSelect').value;
    const trxId = document.getElementById('buyNowOrderTrxId').value.trim();
    const trxImgFile = document.getElementById('buyNowOrderTrxImg').files[0];
    const name = document.getElementById('buyNowOrderName').value.trim();
    const phone = document.getElementById('buyNowOrderPhone').value.trim();
    const addr = document.getElementById('buyNowOrderAddress').value.trim();

    if (!name || !phone || !addr) {
        return showToast("Name, Phone and Address are required!");
    }

    if (method === 'jazzcash' && (!trxId || !trxImgFile)) {
        return showToast("Please enter Trx ID and upload payment screenshot for JazzCash!");
    }

    loaderOverlay.style.display = 'flex';

    try {
        const items = [{
            id: currentDetailProduct.id,
            name: currentDetailProduct.name,
            price: currentDetailProduct.disc_price || currentDetailProduct.price,
            img: currentDetailProduct.img
        }];
        // Check & decrease stock safely
        for (let item of items) {
            const { data: prod, error: stockErr } = await _supabase
                .from('products')
                .select('stock')
                .eq('id', item.id)
                .single();

            if (stockErr || !prod) throw new Error("Product not found");
            if (prod.stock <= 0) throw new Error(`${item.name} is out of stock!`);

            const newStock = prod.stock - 1;

            const { error: updateErr } = await _supabase
                .from('products')
                .update({ stock: newStock })
                .eq('id', item.id);

            if (updateErr) throw updateErr;
        }

        let trxBase64 = null;
        if (method === 'jazzcash' && trxImgFile) {
            trxBase64 = await toBase64(trxImgFile);
        }

        const orderId = 'ORD' + Math.floor(100000 + Math.random() * 900000);
        const total = items.reduce((sum, i) => sum + i.price, 0);

        const { error: orderErr } = await _supabase.from('orders').insert([{ 
            order_id: orderId,
            user_email: currentUser.email,
            customer_name: name,
            customer_phone: phone,
            address: addr,
            total_price: total,
            status: 'Pending',
            trx_id: method === 'cod' ? null : trxId,
            trx_img: trxBase64,
            items: items
        }]);

        if (orderErr) throw orderErr;

        showToast("Order Placed Successfully! ‚úì");
        switchSection('ordersSection');
        fetchOrders();
        if (isAdmin) fetchProofs();

    } catch (e) {
        console.error(e);
        showToast("Order failed: " + (e.message || "Unknown error"));
    } finally {
        loaderOverlay.style.display = 'none';
    }
}

async function editProduct(id) {
    editingProduct = {...currentDetailProduct, id: id};
    document.getElementById('editPName').value = editingProduct.name;
    document.getElementById('editPDesc').value = editingProduct.desc || '';
    document.getElementById('editPBasePrice').value = editingProduct.price;
    document.getElementById('editPDiscPrice').value = editingProduct.disc_price || '';
    document.getElementById('editPStock').value = editingProduct.stock;
    document.getElementById('currentImagesPreview').innerHTML = (editingProduct.images || [editingProduct.img]).map(img => `<img src="${img}" class="preview-img">`).join('');
    document.getElementById('currentVideoPreview').innerHTML = editingProduct.video ? `<video controls src="${editingProduct.video}" style="width:100%; height:150px;"></video>` : 'No video';
    switchSection('editProductSection');
}

async function saveEditedProduct() {
    if(!editPName.value || !editPBasePrice.value || !editPStock.value) return showToast("Enter required details");
    loaderOverlay.style.display = 'flex';
    let imgs = editingProduct.images || [editingProduct.img];
    if(editPImages.files.length) {
        if(editPImages.files.length > 3) return showToast("Max 3 images");
        imgs = await Promise.all([...editPImages.files].map(toBase64));
    }
    let video = editingProduct.video;
    if(editPVideo.files[0]) video = await toBase64(editPVideo.files[0]);
    await _supabase.from('products').update({ name: editPName.value, price: editPBasePrice.value, stock: parseInt(editPStock.value), img: imgs[0] || '' }).eq('id', editingProduct.id);
    await _supabase.from('product_details').upsert([{ product_id: editingProduct.id, description: editPDesc.value, discount_price: editPDiscPrice.value, images: imgs, video: video }], { onConflict: 'product_id' });
    loaderOverlay.style.display = 'none';
    showToast("Product Updated!");
    loadProducts();
    switchSection('homeSection');
}

async function fetchOrders() {
    const { data } = await _supabase.from('orders').select('*').order('id', {ascending: false});
    const list = isAdmin ? (data || []) : (data ? data.filter(o => o.user_email === currentUser.email) : []);
    if(isAdmin) {
        adminOrderSelect.innerHTML = '<option value="">Select Order</option>' + list.map(o => `<option value="${o.order_id}">${o.order_id} - ${o.customer_name}</option>`).join('');
    }
    userOrdersList.innerHTML = list.map(o => `
        <div style="background:white; padding:15px; border-radius:10px; margin-bottom:10px; border-left:5px solid var(--primary)">
            <span class="status-badge ${o.status}">${o.status}</span>
            <b>ID: ${o.order_id}</b><br>
            <small>Total: Rs ${o.total_price} | Payment: ${o.trx_id ? 'JazzCash' : 'COD'}</small>
            <div>Items: ${o.items ? o.items.map(i => i.name).join(', ') : 'N/A'}</div>
            ${isAdmin ? `
                <div>üë§ ${o.customer_name} | üìû ${o.customer_phone}<br>üìç ${o.address}</div>
                <select style="margin-top:10px" onchange="updateStatus('${o.order_id}', this.value)">
                    <option value="Pending" ${o.status==='Pending'?'selected':''}>Pending</option>
                    <option value="Processing" ${o.status==='Processing'?'selected':''}>Processing</option>
                    <option value="Shipped" ${o.status==='Shipped'?'selected':''}>Shipped</option>
                    <option value="Delivered" ${o.status==='Delivered'?'selected':''}>Delivered</option>
                    <option value="Cancelled" ${o.status==='Cancelled'?'selected':''}>Cancelled</option>
                </select>
            ` : ''}
            ${!isAdmin && (o.status === 'Delivered' || o.status === 'Cancelled') ? `<button class="btn-small btn-delete" onclick="deleteUserOrder('${o.order_id}')">Delete</button>` : ''}
        </div>`).join('');
}

async function deleteUserOrder(id) {
    openConfirm("Delete this order?", async () => {
        await _supabase.from('orders').delete().eq('order_id', id).eq('user_email', currentUser.email);
        fetchOrders();
    });
}

async function fetchProofs() {
    const { data } = await _supabase.from('orders').select('*').not('trx_id', 'is', null);
    if(data) {
        adminProofSelect.innerHTML = '<option value="">Select Proof</option>' + data.map(p => `<option value="${p.order_id}">${p.order_id}</option>`).join('');
        proofsList.innerHTML = data.map(p => `
            <div style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <b>Order ${p.order_id}</b> - Trx ${p.trx_id}<br>
                <img src="${p.trx_img}" style="width:100px; border-radius:8px;"><br>
                <button class="btn-small btn-order" onclick="whatsappTo('${p.customer_phone}', '${p.order_id}')">Confirm on WA</button>
            </div>
        `).join('');
    }
}

function whatsappTo(phone, id) {
    if(phone.startsWith('0')) phone = '92' + phone.slice(1);
    location.href = `https://wa.me/+${phone}?text=Your order ${id} is confirmed!`;
}

function toggleOrderDelBtn() { adminDelOrderBtn.style.display = adminOrderSelect.value ? 'block' : 'none'; }
function toggleProofDelBtn() { adminDelProofBtn.style.display = adminProofSelect.value ? 'block' : 'none'; }

function toBase64(file) { return new Promise((resolve) => { const r = new FileReader(); r.readAsDataURL(file); r.onload = () => resolve(r.result); }); }

async function addNewProduct() { 
    if(!pName.value || !pBasePrice.value || !pStock.value || !pImages.files.length) return showToast("Enter all required details");
    if(pImages.files.length > 3) return showToast("Max 3 images");
    loaderOverlay.style.display = 'flex';
    const imgs = await Promise.all([...pImages.files].map(toBase64));
    const video = pVideo.files[0] ? await toBase64(pVideo.files[0]) : null;
    const { data: prod } = await _supabase.from('products').insert([{ name: pName.value, price: pBasePrice.value, stock: parseInt(pStock.value), img: imgs[0] || '' }]).select().single(); 
    if(prod) await _supabase.from('product_details').insert([{ product_id: prod.id, description: pDesc.value, discount_price: pDiscPrice.value, images: imgs, video: video }]);
    loaderOverlay.style.display = 'none'; 
    showToast("Product Added!");
    loadProducts(); 
}

async function deleteProduct(id) { 
    openConfirm("Delete product?", async () => { 
        await _supabase.from('products').delete().eq('id', id); 
        await _supabase.from('product_details').delete().eq('product_id', id);
        loadProducts(); 
        if(editingProduct && editingProduct.id === id) switchSection('homeSection');
    }); 
}

async function updateStatus(id, s) { 
    loaderOverlay.style.display = 'flex';
    await _supabase.from('orders').update({ status: s }).eq('order_id', id); 
    loaderOverlay.style.display = 'none'; showToast("Status Updated!"); fetchOrders(); 
}

async function deleteSelectedOrder() {
    const id = adminOrderSelect.value;
    if(!id) return;
    openConfirm("Delete order?", async () => {
        await _supabase.from('orders').delete().eq('order_id', id);
        fetchOrders(); fetchProofs();
    });
}

async function deleteSelectedProof() {
    const id = adminProofSelect.value;
    if(!id) return;
    openConfirm("Delete proof?", async () => {
        await _supabase.from('orders').update({ trx_id: null, trx_img: null }).eq('order_id', id);
        fetchProofs();
    });
}

function switchSection(id, btn) { 
    document.querySelectorAll('.section').forEach(s => s.style.display = 'none'); 
    document.getElementById(id).style.display = 'block'; 
    if(btn) { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('nav-active')); btn.classList.add('nav-active'); }
    if(id === 'cartSection') renderCart();
}

function addToCart(buyNow = false) {
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    if(cart.find(c => c.id === currentDetailProduct.id)) return showToast("Already in cart!");
    const item = {
        id: currentDetailProduct.id,
        name: currentDetailProduct.name,
        price: currentDetailProduct.disc_price || currentDetailProduct.price,
        img: currentDetailProduct.img
    };
    cart.push(item);
    localStorage.setItem('cart', JSON.stringify(cart));
    showToast("Added to Cart!");
    if(buyNow) {
        switchSection('cartSection');
    }
}

function renderCart() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    if(cart.length === 0) {
        document.getElementById('cartItems').innerHTML = '<h3 style="text-align:center;">THERE IS NO PRODUCT IN CART</h3><button class="btn-main" style="width:100%; margin-top:10px;" onclick="switchSection(\'homeSection\')">Explore</button>';
        document.getElementById('deleteSelectedCart').style.display = 'none';
        document.getElementById('checkoutBtn').style.display = 'none';
        document.getElementById('checkoutForm').style.display = 'none';
        return;
    }
    document.getElementById('cartItems').innerHTML = cart.map(c => `
        <div class="cart-item">
            <input type="checkbox" data-id="${c.id}" onchange="updateCartUI()">
            <img src="${c.img}">
            <div>
                <b>${c.name}</b><br>
                Rs ${c.price}
            </div>
        </div>
    `).join('');
    updateCartUI();
}

function updateCartUI() {
    const checked = [...document.querySelectorAll('#cartItems input[type="checkbox"]:checked')].map(ch => ch.dataset.id);
    document.getElementById('deleteSelectedCart').style.display = checked.length > 0 ? 'block' : 'none';
    document.getElementById('checkoutBtn').style.display = checked.length > 0 ? 'block' : 'none';
    document.getElementById('checkoutForm').style.display = 'none';
}

function deleteSelectedCartItems() {
    const checked = [...document.querySelectorAll('#cartItems input[type="checkbox"]:checked')].map(ch => ch.dataset.id);
    if(checked.length === 0) return;
    openConfirm("Delete selected items?", () => {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        cart = cart.filter(c => !checked.includes(c.id.toString()));
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
    });
}

function showCheckoutForm() {
    const checked = [...document.querySelectorAll('#cartItems input[type="checkbox"]:checked')].map(ch => ch.dataset.id);
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const selected = cart.filter(c => checked.includes(c.id.toString()));
    const total = selected.reduce((sum, s) => sum + s.price, 0);
    document.getElementById('cartTotal').innerText = total;
    document.getElementById('orderName').value = userSavedName;
    document.getElementById('orderAddress').value = userSavedAddress;
    checkLayyahCity();
    document.getElementById('checkoutForm').style.display = 'block';
    currentDetailProduct = { items: selected }; // Temp for placeOrder
}

async function placeOrder() {
    const method = document.getElementById('payMethodSelect').value;
    const trxId = document.getElementById('orderTrxId').value.trim();
    const trxImgFile = document.getElementById('orderTrxImg').files[0];
    const name = document.getElementById('orderName').value.trim();
    const phone = document.getElementById('orderPhone').value.trim();
    const addr = document.getElementById('orderAddress').value.trim();

    if (!name || !phone || !addr) {
        return showToast("Name, Phone and Address are required!");
    }

    if (method === 'jazzcash' && (!trxId || !trxImgFile)) {
        return showToast("Please enter Trx ID and upload payment screenshot for JazzCash!");
    }

    loaderOverlay.style.display = 'flex';

    try {
        const items = currentDetailProduct.items || [];
        if (items.length === 0) throw new Error("No items selected");

        // Check & decrease stock safely
        for (let item of items) {
            const { data: prod, error: stockErr } = await _supabase
                .from('products')
                .select('stock')
                .eq('id', item.id)
                .single();

            if (stockErr || !prod) throw new Error("Product not found");
            if (prod.stock <= 0) throw new Error(`${item.name} is out of stock!`);

            const newStock = prod.stock - 1;

            const { error: updateErr } = await _supabase
                .from('products')
                .update({ stock: newStock })
                .eq('id', item.id);

            if (updateErr) throw updateErr;
        }

        let trxBase64 = null;
        if (method === 'jazzcash' && trxImgFile) {
            trxBase64 = await toBase64(trxImgFile);
        }

        const orderId = 'ORD' + Math.floor(100000 + Math.random() * 900000);
        const total = items.reduce((sum, i) => sum + i.price, 0);

        const { error: orderErr } = await _supabase.from('orders').insert([{ 
            order_id: orderId,
            user_email: currentUser.email,
            customer_name: name,
            customer_phone: phone,
            address: addr,
            total_price: total,
            status: 'Pending',
            trx_id: method === 'cod' ? null : trxId,
            trx_img: trxBase64,
            items: items
        }]);

        if (orderErr) throw orderErr;

        localStorage.removeItem('cart');
        showToast("Order Placed Successfully! ‚úì");
        renderCart();
        switchSection('ordersSection');
        fetchOrders();
        if (isAdmin) fetchProofs();

    } catch (e) {
        console.error(e);
        showToast("Order failed: " + (e.message || "Unknown error"));
    } finally {
        loaderOverlay.style.display = 'none';
    }
}

function showToast(m) { customToast.innerText = m; customToast.style.display = 'block'; setTimeout(()=>customToast.style.display='none',3000); }
function userLogout() { localStorage.removeItem('helloShopUser'); localStorage.removeItem('cart'); location.reload(); }
function toggleChat() { chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex'; }
async function sendMsg() { 
    if (chatInput.value.trim() === '') return;
    await _supabase.from('messages').insert([{ sender: isAdmin ? ADMIN_EMAIL : currentUser.email, text: chatInput.value }]); 
    chatInput.value = ""; 
}
function listenChat() { _supabase.channel('any').on('postgres_changes', { event: 'INSERT', table: 'messages' }, () => renderMessages()).subscribe(); renderMessages(); }
async function renderMessages() {
    const { data: messages } = await _supabase.from('messages').select('*').order('created_at', {ascending: true});
    if(!messages) return;
    // Fetch profiles for unique senders
    const uniqueSenders = [...new Set(messages.map(m => m.sender))].filter(s => s !== ADMIN_EMAIL);
    if (uniqueSenders.length > 0) {
        const { data: profiles } = await _supabase.from('profiles').select('email, full_name, profile_pic').in('email', uniqueSenders);
        userProfiles = profiles.reduce((acc, p) => {
            acc[p.email] = { name: p.full_name || p.email, dp: p.profile_pic || 'https://cdn-icons-png.flaticon.com/512/149/149071.png' };
            return acc;
        }, {});
    }
    const filtered = messages.filter(m => {
        if (isAdmin) return true;
        return m.sender === currentUser.email || m.sender === ADMIN_EMAIL;
    });
    chatMessages.innerHTML = filtered.map(m => {
        const isMe = m.sender === (isAdmin ? ADMIN_EMAIL : currentUser.email);
        const name = isMe ? (isAdmin ? 'Admin' : userSavedName || 'You') : (m.sender === ADMIN_EMAIL ? 'Admin' : userProfiles[m.sender]?.name || m.sender);
        const dp = isMe ? (isAdmin ? 'https://cdn-icons-png.flaticon.com/512/149/149071.png' : document.getElementById('userProfilePic').src) : (m.sender === ADMIN_EMAIL ? 'https://cdn-icons-png.flaticon.com/512/149/149071.png' : userProfiles[m.sender]?.dp || 'https://cdn-icons-png.flaticon.com/512/149/149071.png');
        return `<div class="${isMe ? 'msg-me' : 'msg-them'} msg">
            <div class="msg-header ${isMe ? 'msg-me' : 'msg-them'}">
                <img src="${dp}">
                ${name}
            </div>
            ${m.text}
        </div>`;
    }).join('');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}
function searchProducts() { renderHomeProducts(allProducts.filter(p => p.name.toLowerCase().includes(searchBar.value.toLowerCase()))); }
</script>
</body>
</html>
